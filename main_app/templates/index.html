<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Neuronal Interactiva</title>
    <style>
        /* Estilos generales del cuerpo */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* Contenedor principal de la aplicación */
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 900px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        /* Título de la aplicación */
        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 25px;
        }

        /* Estilos de la consola de chat */
        #consola {
            background-color: #1e1e1e;
            color: #0f0;
            border: 1px solid #000;
            height: 400px; /* Altura fija */
            overflow-y: scroll; /* Habilitar scroll vertical */
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Estilos para los tipos de mensajes en la consola */
        .mensaje {
            margin-bottom: 5px;
        }
        .mensaje.info { color: #0f0; }
        .mensaje.error { color: #f00; }
        .mensaje.warning { color: #ff0; }
        .mensaje.comando { color: #0ff; }
        .mensaje.ia { color: #fff; } /* Mensajes de la IA */
        .mensaje.confirmacion { color: #add8e6; } /* Azul claro para mensajes de confirmación */


        /* Área de entrada de comandos */
        .input-area {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        #comandoInput {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        /* Estilos del botón de enviar */
        button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:active {
            background-color: #004085;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Sección de estado de la red */
        .estado-red {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9e9e9;
            border-radius: 8px;
        }
        .estado-red h2 {
            margin-top: 0;
            color: #0056b3;
        }
        .estado-red pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Estilos para el área de confirmación */
        #confirmacionGuardado {
            margin-top: 15px;
            padding: 15px;
            background-color: #e0f7fa; /* Un azul muy claro */
            border: 1px solid #b2ebf2;
            border-radius: 8px;
            text-align: center;
            display: none; /* Oculto por defecto */
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        #confirmacionGuardado p {
            margin: 0;
            color: #00796b; /* Verde oscuro para el texto */
            font-weight: bold;
        }

        #confirmacionGuardado .button-group button {
            margin: 0 5px;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        #confirmacionGuardado .button-group button.yes {
            background-color: #28a745; /* Verde para Sí */
        }
        #confirmacionGuardado .button-group button.yes:hover {
            background-color: #218838;
        }
        #confirmacionGuardado .button-group button.no {
            background-color: #dc3545; /* Rojo para No */
        }
        #confirmacionGuardado .button-group button.no:hover {
            background-color: #c82333;
        }


        /* Media queries para responsividad en pantallas más pequeñas */
        @media (max-width: 600px) {
            .input-area {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
            #confirmacionGuardado .button-group {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            #confirmacionGuardado .button-group button {
                margin: 5px 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simulador de Red Neuronal Elemental</h1>
        <div id="consola"></div>
        <div class="input-area">
            <input type="text" id="comandoInput" placeholder="Introduce un comando (ej: ayuda)">
            <button onclick="enviarComando()">Enviar</button>
        </div>
        <div id="confirmacionGuardado">
            <p>¿Quieres guardar esta respuesta en la memoria de la IA?</p>
            <div class="button-group">
                <button class="yes" onclick="confirmSave('yes')">Sí</button>
                <button class="no" onclick="confirmSave('no')">No</button>
            </div>
        </div>
    </div>
    <div class="container estado-red">
        <h2>Estado Actual de la Red</h2>
        <pre id="estadoRed"></pre>
    </div>

    <script>
        const FLASK_SERVER_URL = `http://${window.location.hostname}:5000`; 

        const consola = document.getElementById('consola');
        const comandoInput = document.getElementById('comandoInput');
        const estadoRedElement = document.getElementById('estadoRed');
        const confirmacionGuardado = document.getElementById('confirmacionGuardado');

        async function enviarComando() {
            const comando = comandoInput.value;
            if (!comando) return;

            console.log(`DEBUG (Frontend): Enviando comando: '${comando}'`);

            comandoInput.value = ''; 
            confirmacionGuardado.style.display = 'none'; 

            try {
                const response = await fetch(FLASK_SERVER_URL + '/enviar_comando', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ comando: comando })
                });
                const contentType = response.headers.get("content-type");

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`ERROR (Frontend): HTTP Error ${response.status} al enviar comando:`, errorText);
                    mostrarMensaje(`Error del servidor (${response.status}) al enviar comando.`, 'error');
                    return;
                }

                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    console.log('DEBUG (Frontend): Respuesta del servidor (JSON):', data);

                    actualizarConsola(data.log);
                    actualizarEstadoRed(data.estado_red || []);

                    if (data.should_offer_to_save) {
                        mostrarMensaje("La IA ha generado una nueva respuesta.", 'confirmacion');
                        confirmacionGuardado.style.display = 'flex'; 
                    }
                } else {
                    const textResponse = await response.text();
                    console.error('ERROR (Frontend): Se esperaba JSON para /enviar_comando, pero se recibió:', textResponse);
                    mostrarMensaje('Error: Formato de respuesta inesperado del servidor para el comando. ¿El servidor está devolviendo HTML?', 'error');
                }
            } catch (error) {
                mostrarMensaje('Error al enviar comando: ' + error, 'error');
                console.error('ERROR (Frontend): Error en fetch al enviar comando:', error);
            }
        }

        async function confirmSave(choice) {
            confirmacionGuardado.style.display = 'none'; 

            try {
                const response = await fetch(FLASK_SERVER_URL + '/confirm_save', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ choice: choice })
                });
                const contentType = response.headers.get("content-type");

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`ERROR (Frontend): HTTP Error ${response.status} al confirmar guardado:`, errorText);
                    mostrarMensaje(`Error del servidor (${response.status}) al confirmar guardado.`, 'error');
                    return;
                }

                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    console.log('DEBUG (Frontend): Respuesta de confirmación (JSON):', data);
                    mostrarMensaje(data.message, 'info'); 
                    actualizarConsola(data.log); 
                    actualizarEstadoRed(data.estado_red || []);
                } else {
                    const textResponse = await response.text();
                    console.error('ERROR (Frontend): Se esperaba JSON para /confirm_save, pero se recibió:', textResponse);
                    mostrarMensaje('Error: Formato de respuesta inesperado del servidor para la confirmación.', 'error');
                }
            } catch (error) {
                mostrarMensaje('Error al confirmar guardado: ' + error, 'error');
                console.error('ERROR (Frontend): Error en fetch al confirmar guardado:', error);
            }
        }

        function actualizarConsola(mensajes) {
            consola.innerHTML = '';
            mensajes.forEach(msg => {
                const p = document.createElement('p');
                p.classList.add('mensaje', msg.tipo);
                p.textContent = `[${msg.tiempo}] ${msg.mensaje}`;
                consola.appendChild(p);
            });
            consola.scrollTop = consola.scrollHeight;
        }

        function actualizarEstadoRed(estado_red) {
            let estadoTexto = '';
            if (estado_red.length === 0) {
                estadoTexto = "No hay neuronas en la red.";
            } else {
                estado_red.forEach(n => {
                    // Asegurarse de que solo se muestren propiedades relevantes para el estado
                    if (n.tipo === "Sistema") {
                        estadoTexto += `Tipo: ${n.tipo}, RAM: ${n["RAM Disponible (MB)"]}MB, CPU: ${n["Núcleos CPU"]}, Disco: ${n["Uso Disco (%)"]}%\n`;
                    } else {
                        estadoTexto += `ID: ${n.id}, Pregunta: '${n.pregunta}', Respuesta: '${n.respuesta_corta}', Embedding Len: ${n.embedding_len}\n`;
                    }
                });
            }
            estadoRedElement.textContent = estadoTexto;
        }

        function mostrarMensaje(mensaje, tipo) {
            const p = document.createElement('p');
            p.classList.add('mensaje', tipo);
            p.textContent = `[${new Date().toLocaleTimeString()}] ${mensaje}`;
            consola.appendChild(p);
            consola.scrollTop = consola.scrollHeight;
        }

        async function obtenerActualizacionesPeriodicas() {
            try {
                const response = await fetch(FLASK_SERVER_URL + '/obtener_log'); 
                // No mostrar error si el servidor está temporalmente no disponible (ej. reinicio de Flask)
                if (response.status === 503) { 
                    console.warn('WARN (Frontend): Servidor temporalmente no disponible (503). Reintentando...');
                    return; 
                }

                const contentType = response.headers.get("content-type");

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`ERROR (Frontend): HTTP Error ${response.status} al obtener log:`, errorText);
                    mostrarMensaje(`Error del servidor (${response.status}) al obtener log.`, 'error');
                    return;
                }

                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    actualizarConsola(data.log);
                    actualizarEstadoRed(data.estado_red);
                } else {
                    const textResponse = await response.text();
                    console.error('ERROR (Frontend): Se esperaba JSON para /obtener_log, pero se recibió:', textResponse);
                    mostrarMensaje('Error: Formato de respuesta inesperado del servidor para el log. ¿El servidor está devolviendo HTML?', 'error');
                }
            } catch (error) {
                // Solo mostrar un error general de red si no es un problema de 503
                if (!(error instanceof TypeError && error.message === 'Failed to fetch')) { // Evitar errores de red comunes durante reinicios
                    console.error('ERROR (Frontend): Error en fetch al obtener log:', error);
                    mostrarMensaje('Error de red o procesamiento en el cliente al obtener log.', 'error');
                } else {
                    console.warn('WARN (Frontend): Error de red temporal al obtener log. Reintentando...');
                }
            }
        }

        comandoInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                enviarComando();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            obtenerActualizacionesPeriodicas();
            setInterval(obtenerActualizacionesPeriodicas, 2000);
        });
    </script>
</body>
</html>
